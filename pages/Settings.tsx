
import React, { useState, useEffect } from 'react';
import { useApp } from '../context/AppContext';
import { User, UserRole, Service, SMSConfig, HostConfig } from '../types';
import { Save, Camera, Lock, CreditCard, ShieldCheck, Home, Trash2, Plus, Grid, List, LayoutGrid, Activity, CheckCircle, XCircle, Scale, ClipboardList, MessageSquare, Smartphone, Key, Server, Globe } from 'lucide-react';

export const Settings: React.FC = () => {
  const { currentUser, updateProfile, gatewaySettings, updateGatewaySettings, rooms, addRoom, removeRoom, services, updateService, addService, removeService, productionTolerance, setProductionTolerance, managerTasks, addManagerTask, removeManagerTask, feedingResponsibleRole, setFeedingResponsibleRole, smsConfig, updateSMSConfig, hostConfig, updateHostConfig } = useApp();
  const [formData, setFormData] = useState<Partial<User>>({});
  const [password, setPassword] = useState('');
  const [confirmPassword, setConfirmPassword] = useState('');
  const [activeTab, setActiveTab] = useState<'profile' | 'gateway' | 'management' | 'sms' | 'host'>('profile');
  const [localTolerance, setLocalTolerance] = useState(productionTolerance);
  
  const [gatewayData, setGatewayData] = useState({ merchantId: '', apiKey: '', callbackUrl: '', isEnabled: false });
  const [smsData, setSmsData] = useState<SMSConfig>({ isEnabled: false, provider: 'KavehNegar', apiKey: '', senderLine: '', patternCode: '' });
  const [hostData, setHostData] = useState<HostConfig>({ domain: '', host: '', port: '21', username: '', password: '', protocol: 'FTP' });
  
  const [newRoom, setNewRoom] = useState({ name: '', type: 'Standard', capacity: 1 });
  const [newService, setNewService] = useState<Partial<Service>>({ name: '', price: 0, category: 'Boarding', targetRoomType: 'Standard', defaultCommission: 0 });
  const [newTaskTitle, setNewTaskTitle] = useState('');
  const [newTaskCategory, setNewTaskCategory] = useState('Sanitation');
  const [mgmtSubTab, setMgmtSubTab] = useState<'rooms' | 'services' | 'kitchen' | 'tasks'>('rooms');
  const [roomViewMode, setRoomViewMode] = useState<'list' | 'grid'>('grid');

  useEffect(() => { 
      if (currentUser) { setFormData({ name: currentUser.name, phone: currentUser.phone, email: currentUser.email || '', avatar: currentUser.avatar }); } 
      setGatewayData(gatewaySettings); 
      setSmsData(smsConfig || { isEnabled: false, provider: 'KavehNegar', apiKey: '', senderLine: '', patternCode: '' });
      setHostData(hostConfig || { domain: '', host: '', port: '21', username: '', password: '', protocol: 'FTP' });
  }, [currentUser, gatewaySettings, smsConfig, hostConfig]);

  const isAdmin = currentUser?.roles.includes(UserRole.ADMIN);
  const canManageRooms = isAdmin || currentUser?.permissions.manageRooms;

  const handleSubmit = (e: React.FormEvent) => { e.preventDefault(); if (password && password !== confirmPassword) { alert('رمز عبور و تکرار آن مطابقت ندارند'); return; } updateProfile(formData); alert('پروفایل با موفقیت به روز شد'); };
  const handleGatewaySave = (e: React.FormEvent) => { e.preventDefault(); updateGatewaySettings(gatewayData); alert('تنظیمات درگاه پرداخت ذخیره شد'); };
  const handleSmsSave = (e: React.FormEvent) => { e.preventDefault(); updateSMSConfig(smsData); alert('تنظیمات پنل پیامک ذخیره شد'); };
  const handleHostSave = (e: React.FormEvent) => { e.preventDefault(); updateHostConfig(hostData); alert('تنظیمات هاست و دامین ذخیره شد'); };
  const handleTestConnection = () => { alert('در حال بررسی اتصال به سرور...'); setTimeout(() => alert('اتصال با موفقیت برقرار شد!'), 1500); };

  const handleAddRoom = (e: React.FormEvent) => { e.preventDefault(); if (!newRoom.name) { alert('لطفا نام اتاق را وارد کنید'); return; } addRoom({ id: `r_${Date.now()}`, name: newRoom.name, type: newRoom.type as any, capacity: Number(newRoom.capacity), occupiedBy: [] }); setNewRoom({ name: '', type: 'Standard', capacity: 1 }); alert('اتاق جدید با موفقیت اضافه شد'); };
  const handleAddService = (e: React.FormEvent) => { e.preventDefault(); if (!newService.name) { alert('لطفا نام خدمت را وارد کنید'); return; } if ((newService.price || 0) <= 0) { alert('لطفا مبلغ معتبر وارد کنید'); return; } addService({ id: `s_${Date.now()}`, name: newService.name!, price: Number(newService.price), category: newService.category as any, targetRoomType: newService.category === 'Boarding' ? newService.targetRoomType : undefined, defaultCommission: Number(newService.defaultCommission || 0) }); setNewService({ name: '', price: 0, category: 'Boarding', targetRoomType: 'Standard', defaultCommission: 0 }); alert('تعرفه جدید با موفقیت ثبت شد'); };
  const handleAddTask = (e: React.FormEvent) => { e.preventDefault(); if (!newTaskTitle) return; addManagerTask({ id: `mt_${Date.now()}`, title: newTaskTitle, category: newTaskCategory as any, isEnabled: true }); setNewTaskTitle(''); alert('وظیفه جدید به چک‌لیست اضافه شد'); };
  const handlePriceChange = (id: string, newPrice: string) => { const service = services.find(s => s.id === id); if (service) updateService({ ...service, price: Number(newPrice) }); };
  const handleCommissionChange = (id: string, newComm: string) => { const service = services.find(s => s.id === id); if (service) updateService({ ...service, defaultCommission: Number(newComm) }); };
  const handleToleranceSave = () => { setProductionTolerance(localTolerance); alert('تلورانس تولید غذا بروزرسانی شد'); };

  return (
    <div className="max-w-4xl mx-auto space-y-6">
       <div className="flex items-center justify-between"><h2 className="text-2xl font-bold text-gray-800 dark:text-white">تنظیمات سیستم</h2><div className="flex bg-white dark:bg-gray-800 p-1 rounded-xl border dark:border-gray-700 overflow-x-auto"><button onClick={() => setActiveTab('profile')} className={`px-4 py-2 rounded-lg text-sm font-bold transition-all whitespace-nowrap ${activeTab === 'profile' ? 'bg-blue-600 text-white shadow' : 'text-gray-500'}`}>پروفایل</button>{isAdmin && (<><button onClick={() => setActiveTab('gateway')} className={`px-4 py-2 rounded-lg text-sm font-bold transition-all whitespace-nowrap ${activeTab === 'gateway' ? 'bg-blue-600 text-white shadow' : 'text-gray-500'}`}>درگاه پرداخت</button><button onClick={() => setActiveTab('sms')} className={`px-4 py-2 rounded-lg text-sm font-bold transition-all whitespace-nowrap ${activeTab === 'sms' ? 'bg-blue-600 text-white shadow' : 'text-gray-500'}`}>پنل پیامک</button><button onClick={() => setActiveTab('host')} className={`px-4 py-2 rounded-lg text-sm font-bold transition-all whitespace-nowrap ${activeTab === 'host' ? 'bg-blue-600 text-white shadow' : 'text-gray-500'}`}>هاست و دامین</button></>)}{(isAdmin || canManageRooms) && (<button onClick={() => setActiveTab('management')} className={`px-4 py-2 rounded-lg text-sm font-bold transition-all whitespace-nowrap ${activeTab === 'management' ? 'bg-blue-600 text-white shadow' : 'text-gray-500'}`}>مدیریت پنل</button>)}</div></div>
       {activeTab === 'profile' && (<div className="bg-white dark:bg-gray-800 rounded-2xl p-8 shadow-sm border border-gray-100 dark:border-gray-700 animate-fade-in"><h3 className="text-lg font-bold text-gray-800 dark:text-white mb-6 flex items-center gap-2"><ShieldCheck size={20} className="text-blue-500"/> اطلاعات حساب کاربری</h3><form onSubmit={handleSubmit} className="space-y-6"><div className="flex justify-center mb-6"><div className="relative group cursor-pointer"><img src={formData.avatar} alt="Avatar" className="w-24 h-24 rounded-full border-4 border-gray-100 dark:border-gray-700 object-cover" /><div className="absolute inset-0 bg-black/50 rounded-full flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity"><Camera className="text-white" /></div><input type="text" placeholder="لینک عکس جدید" className="absolute bottom-0 opacity-0 w-full" onChange={(e) => setFormData({...formData, avatar: e.target.value})} /></div></div><div className="grid grid-cols-1 md:grid-cols-2 gap-6"><div><label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">نام و نام خانوادگی</label><input type="text" value={formData.name || ''} onChange={e => setFormData({...formData, name: e.target.value})} className="w-full p-3 rounded-xl bg-gray-50 dark:bg-gray-700 border border-gray-200 dark:border-gray-600 dark:text-white focus:ring-2 focus:ring-blue-500 outline-none" /></div><div><label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">شماره موبایل</label><input type="text" value={formData.phone || ''} onChange={e => setFormData({...formData, phone: e.target.value})} className="w-full p-3 rounded-xl bg-gray-50 dark:bg-gray-700 border border-gray-200 dark:border-gray-600 dark:text-white focus:ring-2 focus:ring-blue-500 outline-none dir-ltr text-right" /></div><div><label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">ایمیل</label><input type="email" value={formData.email || ''} onChange={e => setFormData({...formData, email: e.target.value})} className="w-full p-3 rounded-xl bg-gray-50 dark:bg-gray-700 border border-gray-200 dark:border-gray-600 dark:text-white focus:ring-2 focus:ring-blue-500 outline-none dir-ltr text-right" /></div><div><label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">نقش کاربری</label><div className="w-full p-3 rounded-xl bg-gray-100 dark:bg-gray-900 text-gray-500 border border-gray-200 dark:border-gray-700 cursor-not-allowed">{currentUser?.roles.join(', ')}</div></div></div><div className="border-t dark:border-gray-700 pt-6 mt-2"><h4 className="text-sm font-bold text-gray-600 dark:text-gray-400 mb-4 flex items-center gap-2"><Lock size={16}/>تغییر رمز عبور</h4><div className="grid grid-cols-1 md:grid-cols-2 gap-6"><div><label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">رمز عبور جدید</label><input type="password" value={password} onChange={e => setPassword(e.target.value)} className="w-full p-3 rounded-xl bg-gray-50 dark:bg-gray-700 border border-gray-200 dark:border-gray-600 dark:text-white focus:ring-2 focus:ring-blue-500 outline-none dir-ltr" /></div><div><label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">تکرار رمز عبور</label><input type="password" value={confirmPassword} onChange={e => setConfirmPassword(e.target.value)} className="w-full p-3 rounded-xl bg-gray-50 dark:bg-gray-700 border border-gray-200 dark:border-gray-600 dark:text-white focus:ring-2 focus:ring-blue-500 outline-none dir-ltr" /></div></div></div><button type="submit" className="w-full py-4 bg-blue-600 hover:bg-blue-700 text-white font-bold rounded-xl shadow-lg shadow-blue-600/20 transition-colors flex items-center justify-center gap-2"><Save size={20} />ذخیره پروفایل</button></form></div>)}
       {activeTab === 'gateway' && isAdmin && (<div className="bg-white dark:bg-gray-800 rounded-2xl p-8 shadow-sm border border-gray-100 dark:border-gray-700 animate-fade-in"><h3 className="text-lg font-bold text-gray-800 dark:text-white mb-6 flex items-center gap-2"><CreditCard size={20} className="text-green-500"/>تنظیمات درگاه پرداخت</h3><form onSubmit={handleGatewaySave} className="space-y-6"><div className="flex items-center gap-3 bg-green-50 dark:bg-green-900/20 p-4 rounded-xl border border-green-100 dark:border-green-900/50"><input type="checkbox" id="enableGateway" checked={gatewayData.isEnabled} onChange={e => { const isEnabled = e.target.checked; setGatewayData(prev => ({ ...prev, isEnabled, callbackUrl: isEnabled && !prev.callbackUrl ? 'https://dogclub.ir/verify' : prev.callbackUrl })); }} className="w-5 h-5 text-green-600 rounded focus:ring-green-500" /><label htmlFor="enableGateway" className="text-sm font-bold text-green-800 dark:text-green-200 cursor-pointer">فعال‌سازی پرداخت آنلاین برای کاربران</label></div><div className="grid grid-cols-1 md:grid-cols-2 gap-6"><div><label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">مرچنت کد (Merchant ID)</label><input type="text" value={gatewayData.merchantId} onChange={e => setGatewayData({...gatewayData, merchantId: e.target.value})} className="w-full p-3 rounded-xl bg-gray-50 dark:bg-gray-700 border border-gray-200 dark:border-gray-600 dark:text-white focus:ring-2 focus:ring-green-500 outline-none dir-ltr font-mono text-sm" disabled={!gatewayData.isEnabled} /></div><div><label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">کلید دسترسی (API Key)</label><input type="password" value={gatewayData.apiKey} onChange={e => setGatewayData({...gatewayData, apiKey: e.target.value})} className="w-full p-3 rounded-xl bg-gray-50 dark:bg-gray-700 border border-gray-200 dark:border-gray-600 dark:text-white focus:ring-2 focus:ring-green-500 outline-none dir-ltr font-mono text-sm" disabled={!gatewayData.isEnabled} /></div></div><div><label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">آدرس بازگشت (Callback URL)</label><input type="text" value={gatewayData.callbackUrl} onChange={e => setGatewayData({...gatewayData, callbackUrl: e.target.value})} className="w-full p-3 rounded-xl bg-gray-50 dark:bg-gray-700 border border-gray-200 dark:border-gray-600 dark:text-white focus:ring-2 focus:ring-green-500 outline-none dir-ltr" disabled={!gatewayData.isEnabled} /></div><button type="submit" disabled={!gatewayData.isEnabled && !gatewaySettings.isEnabled} className="w-full py-4 bg-green-600 hover:bg-green-700 disabled:bg-gray-400 text-white font-bold rounded-xl shadow-lg shadow-green-600/20 transition-colors flex items-center justify-center gap-2"><Save size={20} />ذخیره تنظیمات درگاه</button></form></div>)}
       {activeTab === 'sms' && isAdmin && (<div className="bg-white dark:bg-gray-800 rounded-2xl p-8 shadow-sm border border-gray-100 dark:border-gray-700 animate-fade-in"><h3 className="text-lg font-bold text-gray-800 dark:text-white mb-6 flex items-center gap-2"><MessageSquare size={20} className="text-amber-500"/> تنظیمات پنل پیامک (OTP)</h3><form onSubmit={handleSmsSave} className="space-y-6"><div className="flex items-center gap-3 bg-amber-50 dark:bg-amber-900/20 p-4 rounded-xl border border-amber-100 dark:border-amber-900/50"><input type="checkbox" id="enableSMS" checked={smsData.isEnabled} onChange={e => setSmsData(prev => ({ ...prev, isEnabled: e.target.checked }))} className="w-5 h-5 text-amber-600 rounded focus:ring-amber-500" /><label htmlFor="enableSMS" className="text-sm font-bold text-amber-800 dark:text-amber-200 cursor-pointer">فعال‌سازی ورود با رمز یکبار مصرف (OTP)</label></div><div className="grid grid-cols-1 md:grid-cols-2 gap-6"><div><label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">ارائه دهنده (Provider)</label><select className="w-full p-3 rounded-xl bg-gray-50 dark:bg-gray-700 border border-gray-200 dark:border-gray-600 dark:text-white focus:ring-2 focus:ring-amber-500 outline-none" value={smsData.provider} onChange={e => setSmsData({...smsData, provider: e.target.value as any})} disabled={!smsData.isEnabled}><option value="KavehNegar">کاوه نگار</option><option value="FarazSMS">فراز اس‌ام‌اس</option><option value="MeliPayamak">ملی پیامک</option><option value="Other">سایر</option></select></div><div><label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">شماره خط ارسال کننده</label><div className="relative"><Smartphone className="absolute right-3 top-1/2 -translate-y-1/2 text-gray-400" size={18}/><input type="text" value={smsData.senderLine} onChange={e => setSmsData({...smsData, senderLine: e.target.value})} className="w-full pr-10 pl-4 p-3 rounded-xl bg-gray-50 dark:bg-gray-700 border border-gray-200 dark:border-gray-600 dark:text-white focus:ring-2 focus:ring-amber-500 outline-none dir-ltr" disabled={!smsData.isEnabled} /></div></div></div><div className="grid grid-cols-1 md:grid-cols-2 gap-6"><div><label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">کلید API</label><div className="relative"><Key className="absolute right-3 top-1/2 -translate-y-1/2 text-gray-400" size={18}/><input type="password" value={smsData.apiKey} onChange={e => setSmsData({...smsData, apiKey: e.target.value})} className="w-full pr-10 pl-4 p-3 rounded-xl bg-gray-50 dark:bg-gray-700 border border-gray-200 dark:border-gray-600 dark:text-white focus:ring-2 focus:ring-amber-500 outline-none dir-ltr" disabled={!smsData.isEnabled} /></div></div><div><label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">کد پترن (الگوی OTP)</label><input type="text" value={smsData.patternCode} onChange={e => setSmsData({...smsData, patternCode: e.target.value})} className="w-full p-3 rounded-xl bg-gray-50 dark:bg-gray-700 border border-gray-200 dark:border-gray-600 dark:text-white focus:ring-2 focus:ring-amber-500 outline-none dir-ltr" placeholder="مثلا: 12345" disabled={!smsData.isEnabled} /></div></div><button type="submit" disabled={!smsData.isEnabled && !smsConfig.isEnabled} className="w-full py-4 bg-amber-600 hover:bg-amber-700 disabled:bg-gray-400 text-white font-bold rounded-xl shadow-lg shadow-amber-600/20 transition-colors flex items-center justify-center gap-2"><Save size={20} />ذخیره تنظیمات پیامک</button></form></div>)}
       {activeTab === 'host' && isAdmin && (
           <div className="bg-white dark:bg-gray-800 rounded-2xl p-8 shadow-sm border border-gray-100 dark:border-gray-700 animate-fade-in">
               <h3 className="text-lg font-bold text-gray-800 dark:text-white mb-6 flex items-center gap-2"><Server size={20} className="text-cyan-500"/> اتصال به هاست و دامین</h3>
               <form onSubmit={handleHostSave} className="space-y-6">
                   <div className="bg-cyan-50 dark:bg-cyan-900/20 p-4 rounded-xl border border-cyan-100 dark:border-cyan-900/50 mb-6">
                       <p className="text-sm text-cyan-800 dark:text-cyan-200 flex items-center gap-2"><Globe size={16}/> تنظیمات دامنه اصلی</p>
                       <div className="mt-2"><input type="text" placeholder="https://dogclub.ir" className="w-full p-3 rounded-lg border dark:bg-gray-700 dark:border-gray-600 dark:text-white dir-ltr" value={hostData.domain} onChange={e => setHostData({...hostData, domain: e.target.value})} /></div>
                   </div>
                   <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                       <div><label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">آدرس هاست (IP/Hostname)</label><input type="text" className="w-full p-3 rounded-xl border dark:bg-gray-700 dark:border-gray-600 dark:text-white dir-ltr" value={hostData.host} onChange={e => setHostData({...hostData, host: e.target.value})} /></div>
                       <div><label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">پورت</label><input type="text" className="w-full p-3 rounded-xl border dark:bg-gray-700 dark:border-gray-600 dark:text-white dir-ltr" value={hostData.port} onChange={e => setHostData({...hostData, port: e.target.value})} /></div>
                   </div>
                   <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                       <div><label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">نام کاربری FTP/SFTP</label><input type="text" className="w-full p-3 rounded-xl border dark:bg-gray-700 dark:border-gray-600 dark:text-white dir-ltr" value={hostData.username} onChange={e => setHostData({...hostData, username: e.target.value})} /></div>
                       <div><label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">رمز عبور</label><input type="password" className="w-full p-3 rounded-xl border dark:bg-gray-700 dark:border-gray-600 dark:text-white dir-ltr" value={hostData.password} onChange={e => setHostData({...hostData, password: e.target.value})} /></div>
                   </div>
                   <div><label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">پروتکل</label><select className="w-full p-3 rounded-xl border dark:bg-gray-700 dark:border-gray-600 dark:text-white" value={hostData.protocol} onChange={e => setHostData({...hostData, protocol: e.target.value as any})}><option value="FTP">FTP</option><option value="SFTP">SFTP (Secure)</option></select></div>
                   <div className="flex gap-4">
                       <button type="button" onClick={handleTestConnection} className="flex-1 py-4 bg-gray-100 text-gray-700 dark:bg-gray-700 dark:text-gray-300 font-bold rounded-xl hover:bg-gray-200 dark:hover:bg-gray-600 transition-colors">بررسی اتصال</button>
                       <button type="submit" className="flex-1 py-4 bg-cyan-600 text-white font-bold rounded-xl hover:bg-cyan-700 transition-colors shadow-lg shadow-cyan-600/20 flex items-center justify-center gap-2"><Save size={20} /> ذخیره تنظیمات هاست</button>
                   </div>
               </form>
           </div>
       )}
       {activeTab === 'management' && (isAdmin || canManageRooms) && (
           <div className="bg-white dark:bg-gray-800 rounded-2xl p-8 shadow-sm border border-gray-100 dark:border-gray-700 animate-fade-in">
               <h3 className="text-lg font-bold text-gray-800 dark:text-white mb-6 flex items-center gap-2"><Grid size={20} className="text-purple-500"/> مدیریت منابع باشگاه</h3>
               <div className="flex gap-4 border-b dark:border-gray-700 mb-6 overflow-x-auto">{(isAdmin || canManageRooms) && (<button onClick={() => setMgmtSubTab('rooms')} className={`pb-2 px-2 font-medium text-sm transition-colors whitespace-nowrap ${mgmtSubTab === 'rooms' ? 'text-blue-600 border-b-2 border-blue-600' : 'text-gray-500'}`}>اتاق‌ها و قفس‌ها</button>)}{isAdmin && (<><button onClick={() => setMgmtSubTab('services')} className={`pb-2 px-2 font-medium text-sm transition-colors whitespace-nowrap ${mgmtSubTab === 'services' ? 'text-blue-600 border-b-2 border-blue-600' : 'text-gray-500'}`}>تعرفه خدمات و پانسیون</button><button onClick={() => setMgmtSubTab('kitchen')} className={`pb-2 px-2 font-medium text-sm transition-colors whitespace-nowrap ${mgmtSubTab === 'kitchen' ? 'text-blue-600 border-b-2 border-blue-600' : 'text-gray-500'}`}>تنظیمات آشپزخانه</button><button onClick={() => setMgmtSubTab('tasks')} className={`pb-2 px-2 font-medium text-sm transition-colors whitespace-nowrap ${mgmtSubTab === 'tasks' ? 'text-blue-600 border-b-2 border-blue-600' : 'text-gray-500'}`}>طراحی چک‌لیست وظایف</button></>)}</div>
               {mgmtSubTab === 'kitchen' && isAdmin && (<div className="space-y-4 bg-gray-50 dark:bg-gray-700/30 p-6 rounded-xl"><h4 className="font-bold dark:text-white mb-4 flex items-center gap-2"><Scale size={18}/> پارامترهای تولید غذا</h4><div className="flex items-center gap-4"><label className="text-sm text-gray-600 dark:text-gray-300">درصد افت پخت (Waste/Shrinkage):</label><input type="number" value={localTolerance} onChange={e => setLocalTolerance(Number(e.target.value))} className="w-20 p-2 rounded border dark:bg-gray-700 dark:border-gray-600 dark:text-white text-center" /><span className="text-gray-500 text-sm">%</span><button onClick={handleToleranceSave} className="bg-blue-600 text-white px-4 py-2 rounded-lg text-sm flex items-center gap-1"><Save size={16} />ذخیره</button></div><p className="text-xs text-gray-500 mt-2">این درصد به عنوان ضایعات یا کاهش وزن ناشی از پخت (مانند تبخیر آب) از وزن اولیه مواد کسر می‌شود.</p><div className="border-t dark:border-gray-600 pt-4 mt-4"><h4 className="font-bold dark:text-white mb-2 text-sm">مسئول ثبت تغذیه</h4><p className="text-xs text-gray-500 mb-2">هشدارهای "عدم ثبت تغذیه" در داشبورد کدام نقش نمایش داده شود؟</p><select className="p-2 rounded border dark:bg-gray-700 dark:border-gray-600 dark:text-white text-sm" value={feedingResponsibleRole} onChange={(e) => setFeedingResponsibleRole(e.target.value as UserRole)}><option value={UserRole.STAFF}>پرسنل ساده</option><option value={UserRole.TRAINER}>مربی</option><option value={UserRole.INTERNAL_MANAGER}>مدیر داخلی</option><option value={UserRole.VET}>دامپزشک (توصیه نمی‌شود)</option></select></div></div>)}
               {mgmtSubTab === 'tasks' && isAdmin && (<div className="space-y-6"><div className="bg-blue-50 dark:bg-blue-900/20 p-4 rounded-xl border border-blue-100 dark:border-blue-800"><h4 className="font-bold text-blue-800 dark:text-blue-200 mb-2 flex items-center gap-2"><ClipboardList size={18}/> فرم ساز وظایف مدیر داخلی</h4><p className="text-xs text-blue-600 dark:text-blue-300">در این بخش می‌توانید چک‌لیست روزانه مدیر داخلی را طراحی کنید. این موارد در داشبورد مدیر داخلی نمایش داده شده و پس از تایید برای شما ارسال می‌گردد.</p></div><form onSubmit={handleAddTask} className="flex flex-col md:flex-row gap-4 bg-gray-50 dark:bg-gray-700/30 p-4 rounded-xl items-end"><div className="flex-1 w-full"><label className="block text-xs mb-1 dark:text-gray-300">عنوان وظیفه</label><input type="text" placeholder="مثلا: بررسی قفل درب‌ها" className="w-full p-2 rounded-lg border dark:bg-gray-700 dark:border-gray-600 dark:text-white" value={newTaskTitle} onChange={e => setNewTaskTitle(e.target.value)} required /></div><div className="w-full md:w-48"><label className="block text-xs mb-1 dark:text-gray-300">دسته‌بندی</label><select className="w-full p-2 rounded-lg border dark:bg-gray-700 dark:border-gray-600 dark:text-white" value={newTaskCategory} onChange={e => setNewTaskCategory(e.target.value)}><option value="Sanitation">نظافت و بهداشت</option><option value="Security">امنیت و حراست</option><option value="Logistics">تدارکات و انبار</option><option value="Staff">مدیریت پرسنل</option><option value="Other">سایر موارد</option></select></div><button type="submit" className="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 h-10 flex items-center justify-center gap-2 w-full md:w-auto"><Plus size={18}/> افزودن</button></form><div className="bg-white dark:bg-gray-800 border dark:border-gray-700 rounded-xl overflow-hidden"><table className="w-full text-right text-sm"><thead className="bg-gray-100 dark:bg-gray-700 text-gray-600 dark:text-gray-300"><tr><th className="p-3">عنوان وظیفه</th><th className="p-3">دسته‌بندی</th><th className="p-3 text-left">عملیات</th></tr></thead><tbody className="divide-y dark:divide-gray-700">{managerTasks.map(task => (<tr key={task.id} className="hover:bg-gray-50 dark:hover:bg-gray-700/50"><td className="p-3 dark:text-white font-medium">{task.title}</td><td className="p-3"><span className="px-2 py-1 bg-gray-100 dark:bg-gray-600 rounded text-xs text-gray-600 dark:text-gray-300">{task.category}</span></td><td className="p-3 text-left"><button onClick={() => removeManagerTask(task.id)} className="text-red-500 hover:bg-red-50 p-2 rounded-lg transition-colors"><Trash2 size={16}/></button></td></tr>))}{managerTasks.length === 0 && <tr><td colSpan={3} className="p-6 text-center text-gray-400">هیچ وظیفه‌ای تعریف نشده است.</td></tr>}</tbody></table></div></div>)}
               {mgmtSubTab === 'rooms' && (isAdmin || canManageRooms) && (<div className="space-y-6"><div className="grid grid-cols-3 gap-4 mb-4"><div className="bg-blue-50 dark:bg-blue-900/20 p-4 rounded-xl border border-blue-100 dark:border-blue-800 flex items-center justify-between"><div><p className="text-xs text-blue-600 dark:text-blue-400 mb-1">کل اتاق‌ها</p><p className="text-2xl font-bold text-blue-800 dark:text-blue-200">{rooms.length}</p></div><Home className="text-blue-500 opacity-50" size={28} /></div><div className="bg-green-50 dark:bg-green-900/20 p-4 rounded-xl border border-green-100 dark:border-green-800 flex items-center justify-between"><div><p className="text-xs text-green-600 dark:text-green-400 mb-1">ظرفیت خالی</p><p className="text-2xl font-bold text-green-800 dark:text-green-200">{rooms.reduce((acc, r) => acc + (r.capacity - r.occupiedBy.length), 0)}</p></div><Activity className="text-green-500 opacity-50" size={28} /></div><div className="bg-amber-50 dark:bg-amber-900/20 p-4 rounded-xl border border-amber-100 dark:border-amber-800 flex items-center justify-between"><div><p className="text-xs text-amber-600 dark:text-amber-400 mb-1">سگ‌های پذیرش شده</p><p className="text-2xl font-bold text-amber-800 dark:text-amber-200">{rooms.reduce((acc, r) => acc + r.occupiedBy.length, 0)}</p></div><LayoutGrid className="text-amber-500 opacity-50" size={28} /></div></div>{isAdmin && (<form onSubmit={handleAddRoom} className="grid grid-cols-1 md:grid-cols-3 gap-4 bg-gray-50 dark:bg-gray-700/30 p-4 rounded-xl"><input type="text" placeholder="نام اتاق (مثلا: قفس 203)" className="p-2 rounded-lg border dark:bg-gray-700 dark:border-gray-600 dark:text-white" value={newRoom.name} onChange={e => setNewRoom({...newRoom, name: e.target.value})} required /><select className="p-2 rounded-lg border dark:bg-gray-700 dark:border-gray-600 dark:text-white" value={newRoom.type} onChange={e => setNewRoom({...newRoom, type: e.target.value})}><option value="Standard">استاندارد</option><option value="VIP">VIP (دوربین دار)</option><option value="Isolation">قرنطینه</option></select><div className="flex gap-2"><input type="number" placeholder="ظرفیت" className="w-20 p-2 rounded-lg border dark:bg-gray-700 dark:border-gray-600 dark:text-white" value={newRoom.capacity} onChange={e => setNewRoom({...newRoom, capacity: Number(e.target.value)})} min="1" required /><button type="submit" className="flex-1 bg-blue-600 text-white rounded-lg hover:bg-blue-700 flex items-center justify-center gap-2"><Plus size={18}/> افزودن</button></div></form>)}<div className="flex justify-between items-center mt-4"><h4 className="font-bold dark:text-white text-sm">لیست اتاق‌ها و وضعیت اشغال</h4><div className="flex bg-gray-100 dark:bg-gray-700 p-1 rounded-lg"><button onClick={() => setRoomViewMode('list')} className={`p-2 rounded transition-all ${roomViewMode === 'list' ? 'bg-white dark:bg-gray-600 shadow text-blue-600' : 'text-gray-400'}`} title="نمایش لیستی"><List size={18}/></button><button onClick={() => setRoomViewMode('grid')} className={`p-2 rounded transition-all ${roomViewMode === 'grid' ? 'bg-white dark:bg-gray-600 shadow text-blue-600' : 'text-gray-400'}`} title="نمایش شبکه‌ای"><LayoutGrid size={18}/></button></div></div>{roomViewMode === 'grid' ? (<div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4">{rooms.map(room => { const occupiedCount = room.occupiedBy.length; const isFull = occupiedCount >= room.capacity; const isEmpty = occupiedCount === 0; const statusColorClass = isFull ? 'bg-red-50 border-red-200 dark:bg-red-900/10 dark:border-red-900' : isEmpty ? 'bg-green-50 border-green-200 dark:bg-green-900/10 dark:border-green-900' : 'bg-amber-50 border-amber-200 dark:bg-amber-900/10 dark:border-amber-900'; const iconColorClass = isFull ? 'text-red-500' : isEmpty ? 'text-green-500' : 'text-amber-500'; return (<div key={room.id} className={`relative border-2 rounded-2xl p-4 transition-all hover:shadow-lg flex flex-col justify-between min-h-[140px] ${statusColorClass}`}><div className="flex justify-between items-start mb-2"><div><h5 className="font-bold text-gray-800 dark:text-gray-200">{room.name}</h5><span className="text-[10px] bg-white dark:bg-gray-800 px-2 py-0.5 rounded-full border border-gray-100 dark:border-gray-600 text-gray-500">{room.type}</span></div>{isAdmin && <button onClick={() => removeRoom(room.id)} className="text-gray-400 hover:text-red-500 transition-colors"><Trash2 size={16} /></button>}</div><div className="mt-2"><div className="flex justify-between items-end mb-1"><span className={`text-2xl font-black ${iconColorClass}`}>{occupiedCount}<span className="text-sm font-normal text-gray-400">/{room.capacity}</span></span>{isFull ? <XCircle size={24} className="text-red-500 opacity-80" /> : <CheckCircle size={24} className="text-green-500 opacity-80" />}</div><div className="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-2 overflow-hidden"><div className={`h-full transition-all duration-500 ${isFull ? 'bg-red-500' : isEmpty ? 'bg-green-500' : 'bg-amber-500'}`} style={{ width: `${(occupiedCount / room.capacity) * 100}%` }} /></div><p className={`text-xs font-bold mt-1 text-right ${iconColorClass}`}>{isFull ? 'ظرفیت تکمیل' : isEmpty ? 'کاملا آزاد' : 'دارای ظرفیت'}</p></div></div>); })}</div>) : (<div className="overflow-x-auto bg-gray-50 dark:bg-gray-700/30 rounded-xl border dark:border-gray-700"><table className="w-full text-right text-sm"><thead className="bg-gray-100 dark:bg-gray-700 text-gray-600 dark:text-gray-300 border-b dark:border-gray-600"><tr><th className="p-3">نام اتاق</th><th className="p-3">نوع</th><th className="p-3">ظرفیت</th><th className="p-3">وضعیت</th><th className="p-3 text-left">عملیات</th></tr></thead><tbody className="divide-y dark:divide-gray-700">{rooms.map(room => { const isFull = room.occupiedBy.length >= room.capacity; const usagePercent = (room.occupiedBy.length / room.capacity) * 100; return (<tr key={room.id} className="hover:bg-white dark:hover:bg-gray-600/50 transition-colors"><td className="p-3 font-bold dark:text-white">{room.name}</td><td className="p-3"><span className={`px-2 py-1 rounded text-xs ${room.type === 'VIP' ? 'bg-purple-100 text-purple-700' : room.type === 'Isolation' ? 'bg-red-100 text-red-700' : 'bg-gray-100 text-gray-700'}`}>{room.type}</span></td><td className="p-3 dark:text-gray-300">{room.capacity} قلاده</td><td className="p-3"><div className="flex flex-col gap-1 w-32"><div className="flex justify-between text-xs"><span className={isFull ? 'text-red-600 font-bold' : 'text-green-600 font-bold'}>{isFull ? 'تکمیل' : 'آزاد'}</span><span className="text-gray-500 dark:text-gray-400">{room.occupiedBy.length} / {room.capacity}</span></div><div className="w-full bg-gray-200 dark:bg-gray-600 rounded-full h-1.5"><div className={`h-1.5 rounded-full transition-all duration-500 ${isFull ? 'bg-red-500' : room.occupiedBy.length > 0 ? 'bg-amber-400' : 'bg-green-500'}`} style={{ width: `${usagePercent}%` }}></div></div></div></td><td className="p-3 text-left">{isAdmin && <button onClick={() => removeRoom(room.id)} className="text-red-500 hover:bg-red-50 p-2 rounded-lg transition-colors" title="حذف"><Trash2 size={16}/></button>}</td></tr>); })}</tbody></table></div>)}</div>)}
               {mgmtSubTab === 'services' && isAdmin && (<div className="space-y-6"><form onSubmit={handleAddService} className="grid grid-cols-1 md:grid-cols-4 gap-4 bg-gray-50 dark:bg-gray-700/30 p-4 rounded-xl"><input type="text" placeholder="نام خدمت/سرویس" className="md:col-span-2 p-2 rounded-lg border dark:bg-gray-700 dark:border-gray-600 dark:text-white" value={newService.name} onChange={e => setNewService({...newService, name: e.target.value})} required /><select className="p-2 rounded-lg border dark:bg-gray-700 dark:border-gray-600 dark:text-white" value={newService.category} onChange={e => setNewService({...newService, category: e.target.value as any})}><option value="Boarding">پانسیون</option><option value="Training">آموزش</option><option value="Medical">پزشکی</option><option value="Grooming">آرایشگاه</option><option value="Food">غذا و تشویقی</option><option value="Transport">حمل و نقل</option><option value="Other">سایر</option></select>{newService.category === 'Boarding' && (<div className="md:col-span-2 md:col-start-3"><label className="block text-xs mb-1 dark:text-gray-300">اتصال به نوع اتاق</label><select className="w-full p-2 rounded-lg border dark:bg-gray-700 dark:border-gray-600 dark:text-white" value={newService.targetRoomType} onChange={e => setNewService({...newService, targetRoomType: e.target.value as any})}><option value="Standard">اتاق استاندارد</option><option value="VIP">اتاق VIP</option><option value="Isolation">قرنطینه</option></select></div>)}<div className="md:col-span-2 flex gap-2"><div className="flex-1"><label className="block text-xs mb-1 dark:text-gray-300">قیمت (تومان)</label><input type="number" placeholder="مبلغ" className="w-full p-2 rounded-lg border dark:bg-gray-700 dark:border-gray-600 dark:text-white" value={newService.price || ''} onChange={e => setNewService({...newService, price: Number(e.target.value)})} min="0" required /></div><div className="w-24"><label className="block text-xs mb-1 dark:text-gray-300">پورسانت(%)</label><input type="number" placeholder="%" className="w-full p-2 rounded-lg border dark:bg-gray-700 dark:border-gray-600 dark:text-white" value={newService.defaultCommission || ''} onChange={e => setNewService({...newService, defaultCommission: Number(e.target.value)})} min="0" max="100" /></div><div className="flex items-end"><button type="submit" className="bg-blue-600 text-white p-2 rounded-lg hover:bg-blue-700 flex-shrink-0 w-10 h-10 flex items-center justify-center"><Plus size={20}/></button></div></div></form><div className="overflow-x-auto bg-gray-50 dark:bg-gray-700/30 rounded-xl border dark:border-gray-700"><table className="w-full text-right text-sm"><thead className="bg-gray-100 dark:bg-gray-700 text-gray-600 dark:text-gray-300 border-b dark:border-gray-600"><tr><th className="p-3">عنوان خدمت</th><th className="p-3">دسته‌بندی</th><th className="p-3">قیمت (تومان)</th><th className="p-3">پورسانت</th><th className="p-3 text-left">عملیات</th></tr></thead><tbody className="divide-y dark:divide-gray-700">{services.map(service => (<tr key={service.id} className="hover:bg-white dark:hover:bg-gray-600/50 transition-colors"><td className="p-3 font-bold dark:text-white">{service.name}{service.category === 'Boarding' && service.targetRoomType && (<span className="mr-2 text-xs font-normal text-gray-500 bg-gray-200 dark:bg-gray-800 px-1.5 py-0.5 rounded">مخصوص {service.targetRoomType}</span>)}</td><td className="p-3"><span className="px-2 py-1 bg-gray-200 dark:bg-gray-600 rounded text-xs">{service.category}</span></td><td className="p-3"><div className="relative group"><input type="number" className="bg-transparent border-b border-gray-300 dark:border-gray-600 w-24 pl-8 focus:border-blue-500 outline-none dark:text-white transition-colors" defaultValue={service.price} onBlur={(e) => handlePriceChange(service.id, e.target.value)} /><span className="absolute left-0 top-1/2 -translate-y-1/2 text-xs text-gray-400 pointer-events-none">تومان</span></div></td><td className="p-3"><div className="relative group"><input type="number" className="bg-transparent border-b border-gray-300 dark:border-gray-600 w-16 pl-4 focus:border-blue-500 outline-none dark:text-white transition-colors text-center" defaultValue={service.defaultCommission || 0} onBlur={(e) => handleCommissionChange(service.id, e.target.value)} /><span className="absolute left-0 top-1/2 -translate-y-1/2 text-xs text-gray-400 pointer-events-none">%</span></div></td><td className="p-3 text-left"><button onClick={() => removeService(service.id)} className="text-red-500 hover:bg-red-50 p-2 rounded-lg transition-colors"><Trash2 size={16}/></button></td></tr>))}</tbody></table></div></div>)}
           </div>
       )}
    </div>
  );
};
